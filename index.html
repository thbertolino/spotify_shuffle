<!-- In칤cio do c칩digo - index.html -->
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Spotify Shuffle</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 30px;
      background: #fafafa;
    }
    #album img {
      border-radius: 10px;
      margin-top: 15px;
      box-shadow: 0 0 10px rgba(0,0,0,0.25);
    }
    button {
      padding: 12px 20px;
      background: #1db954;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 20px;
    }
    button:hover {
      background: #159c44;
    }
  </style>
</head>
<body>

  <h1>游꿧 Spotify Album Shuffle</h1>

  <button id="login-btn">Login com Spotify</button>

  <div id="album"></div>

  <button id="random-btn" style="display:none;">Outro 치lbum 游</button>

<script>
/* --------------------------------------------------
   CONFIG
-------------------------------------------------- */
const CLIENT_ID = "39300b1668d6473783173aa8629ccf6f";
const REDIRECT_URI = "https://thbertolino.github.io/spotify_shuffle/"; 
const SCOPES = "user-library-read";

/* --------------------------------------------------
   PKCE HELPERS
-------------------------------------------------- */
async function generateCodeVerifier() {
  let array = new Uint8Array(64);
  crypto.getRandomValues(array);
  return btoa(String.fromCharCode.apply(null, array))
    .replace(/\+/g, "-")
    .replace(/\//g, "_")
    .replace(/=/g, "");
}

async function generateCodeChallenge(codeVerifier) {
  const data = new TextEncoder().encode(codeVerifier);
  const digest = await crypto.subtle.digest("SHA-256", data);
  return btoa(String.fromCharCode.apply(null, [...new Uint8Array(digest)]))
    .replace(/\+/g, "-")
    .replace(/\//g, "_")
    .replace(/=/g, "");
}

/* --------------------------------------------------
   REDIRECIONAR PARA LOGIN
-------------------------------------------------- */
document.getElementById("login-btn").onclick = async () => {
  const codeVerifier = await generateCodeVerifier();
  const codeChallenge = await generateCodeChallenge(codeVerifier);

  localStorage.setItem("code_verifier", codeVerifier);

  const params = new URLSearchParams({
    response_type: "code",
    client_id: CLIENT_ID,
    redirect_uri: REDIRECT_URI,
    scope: SCOPES,
    code_challenge_method: "S256",
    code_challenge: codeChallenge,
  });

  window.location = "https://accounts.spotify.com/authorize?" + params.toString();
};

/* --------------------------------------------------
   TROCAR CODE POR TOKEN (PKCE)
-------------------------------------------------- */
async function getToken(code) {
  const codeVerifier = localStorage.getItem("code_verifier");

  const body = new URLSearchParams({
    grant_type: "authorization_code",
    code: code,
    redirect_uri: REDIRECT_URI,
    client_id: CLIENT_ID,
    code_verifier: codeVerifier,
  });

  const response = await fetch("https://accounts.spotify.com/api/token", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: body.toString(),
  });

  return await response.json();
}

/* --------------------------------------------------
   BUSCAR 츼LBUNS SALVOS
-------------------------------------------------- */
async function getSavedAlbums(token) {
  let url = "https://api.spotify.com/v1/me/albums?limit=50";
  let albums = [];

  while (url) {
    const res = await fetch(url, {
      headers: { Authorization: "Bearer " + token }
    });

    const data = await res.json();

    albums = albums.concat(data.items);
    url = data.next;
  }

  return albums;
}

/* --------------------------------------------------
   EXIBIR 츼LBUM
-------------------------------------------------- */
function mostrarAlbum(album) {
  const albumDiv = document.getElementById("album");

  albumDiv.innerHTML = `
    <h2>${album.name}</h2>
    <img src="${album.images[0].url}" width="300">
    <p>${album.artists.map(a => a.name).join(", ")}</p>
    <p><a href="${album.external_urls.spotify}" target="_blank">游꿚 Ouvir no Spotify</a></p>
  `;
}

async function refreshAccessToken() {
  const refreshToken = localStorage.getItem("refresh_token");

  if (!refreshToken) return null;

  const body = new URLSearchParams({
    grant_type: "refresh_token",
    refresh_token: refreshToken,
    client_id: CLIENT_ID
  });

  const response = await fetch("https://accounts.spotify.com/api/token", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: body.toString()
  });

  const data = await response.json();

  if (data.access_token) {
    localStorage.setItem("access_token", data.access_token);
    return data.access_token;
  }

  return null;
}

/* --------------------------------------------------
   FLUXO PRINCIPAL
-------------------------------------------------- */
async function start() {
  const params = new URLSearchParams(window.location.search);
  const code = params.get("code");

  let token = localStorage.getItem("access_token");

  if (token) {
    const test = await fetch("https://api.spotify.com/v1/me", {
      headers: { Authorization: `Bearer ${token}` }
    });

    if (test.status === 401) {
      token = await refreshAccessToken();
    }
  }

  if (code && !token) {
    const tokenResp = await getToken(code);
    localStorage.setItem("access_token", tokenResp.access_token);
    localStorage.setItem("refresh_token", tokenResp.refresh_token);

    window.history.replaceState({}, document.title, REDIRECT_URI);
  }

  if (!token) return;

  document.getElementById("login-btn").style.display = "none";

  async function renderRandom() {
    const album = await getRandomAlbum(token);
    mostrarAlbum(album);
  }

  document.getElementById("random-btn").style.display = "inline-block";
  document.getElementById("random-btn").onclick = renderRandom;

  // primeiro 치lbum ao entrar
  renderRandom();
}

start();

/* --------------------------------------------------
   BUSCAR 츼LBUM ALEAT칍RIO (ULTRA R츼PIDO)
-------------------------------------------------- */
async function getRandomAlbum(token) {
  // 1) pegar total
  const resTotal = await fetch(
    "https://api.spotify.com/v1/me/albums?limit=1",
    {
      headers: { Authorization: `Bearer ${token}` }
    }
  );

  const dataTotal = await resTotal.json();
  const total = dataTotal.total;

  // 2) sortear offset
  const offset = Math.floor(Math.random() * total);

  // 3) buscar apenas esse item
  const resAlbum = await fetch(
    `https://api.spotify.com/v1/me/albums?limit=1&offset=${offset}`,
    {
      headers: { Authorization: `Bearer ${token}` }
    }
  );

  const dataAlbum = await resAlbum.json();
  return dataAlbum.items[0].album;
}

</script>

</body>
</html>
<!-- Fim do c칩digo - index.html -->
