<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Spotify Shuffle</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --spotify-green: #1db954;
      --spotify-green-dark: #159c44;
      --bg-dark: #050816;
      --bg-card: #101827;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --border-radius-lg: 18px;
      --shadow-soft: 0 15px 30px rgba(0, 0, 0, 0.35);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, sans-serif;
      background: radial-gradient(circle at top, #1db95426, #050816 55%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
      padding: 16px;
    }

    .app {
      width: 100%;
      max-width: 420px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      min-height: calc(100vh - 32px);
      padding: 18px 18px 14px;
      background: linear-gradient(145deg, #050816 0%, #020617 45%, #030712 100%);
      border-radius: 24px;
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
    }

    .app::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at 0% 0%, #1db95422, transparent 60%),
        radial-gradient(circle at 100% 100%, #22d3ee18, transparent 55%);
      opacity: 0.7;
      pointer-events: none;
    }

    .app-inner {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      flex: 1;
    }

    header {
      text-align: center;
      margin-bottom: 20px;
    }

    header h1 {
      font-size: 1.6rem;
      font-weight: 800;
      letter-spacing: 0.02em;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    header h1 span.icon {
      font-size: 1.8rem;
      filter: drop-shadow(0 0 10px rgba(129, 140, 248, 0.75));
    }

    header p {
      margin-top: 6px;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 14px;
    }

    .card {
      background: radial-gradient(circle at top, #111827, #020617);
      border-radius: var(--border-radius-lg);
      padding: 16px 16px 18px;
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.8);
      text-align: center;
    }

    .card-header {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    #album-cover {
      width: 72%;
      max-width: 260px;
      aspect-ratio: 1 / 1;
      border-radius: 20px;
      margin: 0 auto 14px;
      overflow: hidden;
      box-shadow:
        0 18px 40px rgba(0, 0, 0, 0.8),
        0 0 0 1px rgba(148, 163, 184, 0.12);
      transform: translateY(0);
      opacity: 0;
      transition: opacity 0.3s ease, transform 0.3s ease;
      background: #020617;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #album-cover img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .album-cover-visible {
      opacity: 1 !important;
      transform: translateY(0) scale(1) !important;
    }

    #album-title {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 4px;
      padding: 0 4px;
    }

    #album-artists {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    .spotify-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
      color: #a7f3d0;
      text-decoration: none;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(16, 185, 129, 0.06);
      border: 1px solid rgba(45, 212, 191, 0.2);
      transition: background 0.2s, transform 0.15s;
    }

    .spotify-link:hover {
      background: rgba(16, 185, 129, 0.12);
      transform: translateY(-1px);
    }

    .spotify-dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.7);
    }

    .helper-text {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 6px;
    }

    .login-hint {
      margin-top: 18px;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .primary-btn {
      width: 100%;
      padding: 13px 14px;
      border-radius: 999px;
      border: none;
      background: var(--spotify-green);
      color: #fff;
      font-size: 0.98rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 12px 22px rgba(16, 185, 129, 0.45);
      transition:
        background 0.2s ease,
        transform 0.12s ease,
        box-shadow 0.2s ease;
      -webkit-tap-highlight-color: transparent;
    }

    .primary-btn span.icon {
      font-size: 1.1rem;
    }

    .primary-btn:hover {
      background: var(--spotify-green-dark);
      transform: translateY(-1px);
      box-shadow: 0 16px 28px rgba(16, 185, 129, 0.55);
    }

    .primary-btn:active {
      transform: translateY(0);
      box-shadow: 0 8px 16px rgba(16, 185, 129, 0.5);
    }

    .primary-btn.disabled,
    .primary-btn:disabled {
      opacity: 0.7;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .secondary-btn {
      background: transparent;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: #e5e7eb;
      box-shadow: none;
      margin-bottom: 8px;
    }

    footer {
      margin-top: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .loading {
      text-align: center;
      font-size: 0.85rem;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    .loading-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #4ade80;
      animation: pulse 1s infinite ease-in-out;
    }

    .loading-dot:nth-child(2) { animation-delay: 0.15s; }
    .loading-dot:nth-child(3) { animation-delay: 0.3s; }

    @keyframes pulse {
      0%, 100% { transform: translateY(0); opacity: 0.4; }
      50% { transform: translateY(-3px); opacity: 1; }
    }

    .hidden {
      display: none !important;
    }

    @media (min-width: 480px) {
      header h1 {
        font-size: 1.7rem;
      }
      #album-title {
        font-size: 1.2rem;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="app-inner">
      <header>
        <h1>
          <span class="icon">üéµ</span>
          <span>Spotify Album Shuffle</span>
        </h1>
        <p>Descubra um √°lbum aleat√≥rio da sua biblioteca.</p>
      </header>

      <main>
        <div id="login-state" class="card" style="display: none;">
          <div class="card-header">Bem-vindo</div>
          <div>
            <p>Fa√ßa login com sua conta Spotify para sortear √°lbuns salvos.</p>
            <p class="helper-text">
              S√≥ usamos permiss√£o de leitura da sua biblioteca &nbsp;üíø
            </p>
          </div>
        </div>

        <div id="album-card" class="card hidden">
          <div class="card-header">√Ålbum sorteado</div>
          <div id="album-cover">
            <!-- Capa aqui -->
          </div>
          <div id="album-title">Selecione um √°lbum para come√ßar</div>
          <div id="album-artists"></div>
          <a id="album-link" class="spotify-link" href="#" target="_blank" rel="noopener noreferrer">
            <span class="spotify-dot"></span>
            <span>Ouvir no Spotify</span>
          </a>
          <div class="helper-text">
            Toque em ‚ÄúOutro √°lbum‚Äù para sortear novamente.
          </div>
        </div>

        <div id="loading" class="loading hidden">
          <div class="loading-dot"></div>
          <div class="loading-dot"></div>
          <div class="loading-dot"></div>
          <span>Carregando √°lbum...</span>
        </div>
      </main>

      <footer>
        <button id="login-btn" class="primary-btn">
          <span class="icon">üîë</span>
          <span>Login com Spotify</span>
        </button>

        <button id="random-btn" class="primary-btn secondary-btn hidden">
          <span class="icon">üé≤</span>
          <span>Outro √°lbum</span>
        </button>

        <div class="login-hint" id="login-hint">
          Dica: adicione mais √°lbuns √† sua biblioteca para aumentar a surpresa. ‚ú®
        </div>
      </footer>
    </div>
  </div>

  <script>
    /* --------------------------------------------------
       CONFIG
    -------------------------------------------------- */
    const CLIENT_ID = "39300b1668d6473783173aa8629ccf6f";
    const REDIRECT_URI = "https://thbertolino.github.io/spotify_shuffle/";
    const SCOPES = "user-library-read";

    const loginBtn = document.getElementById("login-btn");
    const randomBtn = document.getElementById("random-btn");
    const loginStateCard = document.getElementById("login-state");
    const albumCard = document.getElementById("album-card");
    const albumCoverContainer = document.getElementById("album-cover");
    const albumTitleEl = document.getElementById("album-title");
    const albumArtistsEl = document.getElementById("album-artists");
    const albumLinkEl = document.getElementById("album-link");
    const loadingEl = document.getElementById("loading");
    const loginHintEl = document.getElementById("login-hint");

    let isLoadingAlbum = false;

    /* --------------------------------------------------
       PKCE HELPERS
    -------------------------------------------------- */
    async function generateCodeVerifier() {
      const array = new Uint8Array(64);
      crypto.getRandomValues(array);
      return btoa(String.fromCharCode.apply(null, array))
        .replace(/\+/g, "-")
        .replace(/\//g, "_")
        .replace(/=/g, "");
    }

    async function generateCodeChallenge(codeVerifier) {
      const data = new TextEncoder().encode(codeVerifier);
      const digest = await crypto.subtle.digest("SHA-256", data);
      return btoa(String.fromCharCode.apply(null, [...new Uint8Array(digest)]))
        .replace(/\+/g, "-")
        .replace(/\//g, "_")
        .replace(/=/g, "");
    }

    /* --------------------------------------------------
       REDIRECIONAR PARA LOGIN
    -------------------------------------------------- */
    loginBtn.onclick = async () => {
      const codeVerifier = await generateCodeVerifier();
      const codeChallenge = await generateCodeChallenge(codeVerifier);

      localStorage.setItem("code_verifier", codeVerifier);

      const params = new URLSearchParams({
        response_type: "code",
        client_id: CLIENT_ID,
        redirect_uri: REDIRECT_URI,
        scope: SCOPES,
        code_challenge_method: "S256",
        code_challenge: codeChallenge,
      });

      window.location = "https://accounts.spotify.com/authorize?" + params.toString();
    };

    /* --------------------------------------------------
       TROCAR CODE POR TOKEN (PKCE)
    -------------------------------------------------- */
    async function getToken(code) {
      const codeVerifier = localStorage.getItem("code_verifier");

      const body = new URLSearchParams({
        grant_type: "authorization_code",
        code: code,
        redirect_uri: REDIRECT_URI,
        client_id: CLIENT_ID,
        code_verifier: codeVerifier,
      });

      const response = await fetch("https://accounts.spotify.com/api/token", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: body.toString(),
      });

      return await response.json();
    }

    /* --------------------------------------------------
       REFRESH TOKEN
    -------------------------------------------------- */
    async function refreshAccessToken() {
      const refreshToken = localStorage.getItem("refresh_token");
      if (!refreshToken) return null;

      const body = new URLSearchParams({
        grant_type: "refresh_token",
        refresh_token: refreshToken,
        client_id: CLIENT_ID,
      });

      try {
        const response = await fetch("https://accounts.spotify.com/api/token", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: body.toString(),
        });

        const data = await response.json();

        if (data.access_token) {
          localStorage.setItem("access_token", data.access_token);

          // Alguns fluxos retornam novo refresh_token tamb√©m
          if (data.refresh_token) {
            localStorage.setItem("refresh_token", data.refresh_token);
          }

          return data.access_token;
        }
      } catch (err) {
        console.error("Erro ao renovar token:", err);
      }

      return null;
    }

    /* --------------------------------------------------
       BUSCAR √ÅLBUM ALEAT√ìRIO (R√ÅPIDO)
    -------------------------------------------------- */
    async function getRandomAlbum(token) {
      // 1) pegar total de √°lbuns
      const resTotal = await fetch(
        "https://api.spotify.com/v1/me/albums?limit=1",
        {
          headers: { Authorization: `Bearer ${token}` },
        }
      );

      if (resTotal.status === 401) {
        // token inv√°lido ou expirado
        throw new Error("TOKEN_EXPIRED");
      }

      const dataTotal = await resTotal.json();
      const total = dataTotal.total || 0;

      if (total === 0) {
        throw new Error("NO_ALBUMS");
      }

      // 2) sortear offset
      const offset = Math.floor(Math.random() * total);

      // 3) buscar apenas esse item
      const resAlbum = await fetch(
        `https://api.spotify.com/v1/me/albums?limit=1&offset=${offset}`,
        {
          headers: { Authorization: `Bearer ${token}` },
        }
      );

      if (resAlbum.status === 401) {
        throw new Error("TOKEN_EXPIRED");
      }

      const dataAlbum = await resAlbum.json();

      if (!dataAlbum.items || !dataAlbum.items.length) {
        throw new Error("NO_ALBUMS");
      }

      return dataAlbum.items[0].album;
    }

    /* --------------------------------------------------
       EXIBIR √ÅLBUM
    -------------------------------------------------- */
    function mostrarAlbum(album) {
      if (!album) return;

      // Atualiza capa
      albumCoverContainer.innerHTML = "";
      const img = document.createElement("img");
      img.src = album.images?.[0]?.url || "";
      img.alt = album.name || "Capa do √°lbum";
      img.onload = () => {
        albumCoverContainer.classList.add("album-cover-visible");
      };
      albumCoverContainer.classList.remove("album-cover-visible");
      albumCoverContainer.appendChild(img);

      // T√≠tulo e artistas
      albumTitleEl.textContent = album.name || "√Ålbum desconhecido";
      albumArtistsEl.textContent =
        (album.artists || []).map((a) => a.name).join(", ") || "Artista desconhecido";

      // Link Spotify
      if (album.external_urls && album.external_urls.spotify) {
        albumLinkEl.href = album.external_urls.spotify;
        albumLinkEl.classList.remove("hidden");
      } else {
        albumLinkEl.classList.add("hidden");
      }

      // Mostra card
      albumCard.classList.remove("hidden");
    }

    /* --------------------------------------------------
       ESTADOS DE UI
    -------------------------------------------------- */
    function setLoadingAlbum(isLoading) {
      isLoadingAlbum = isLoading;
      if (isLoading) {
        loadingEl.classList.remove("hidden");
        randomBtn.classList.add("disabled");
        randomBtn.disabled = true;
      } else {
        loadingEl.classList.add("hidden");
        randomBtn.classList.remove("disabled");
        randomBtn.disabled = false;
      }
    }

    function setLoggedInUI() {
      loginStateCard.style.display = "none";
      loginBtn.classList.add("hidden");
      loginHintEl.textContent = "Toque em ‚ÄúOutro √°lbum‚Äù para sortear sempre que quiser. üé≤";
      randomBtn.classList.remove("hidden");
    }

    function setLoggedOutUI() {
      loginStateCard.style.display = "block";
      loginBtn.classList.remove("hidden");
      loginBtn.disabled = false;
      randomBtn.classList.add("hidden");
      albumCard.classList.add("hidden");
      loadingEl.classList.add("hidden");
      loginHintEl.textContent =
        "Voc√™ pode desconectar sua conta do Spotify a qualquer momento nas configura√ß√µes do Spotify.";
    }

    /* --------------------------------------------------
       FLUXO PRINCIPAL
    -------------------------------------------------- */
    async function start() {
      const params = new URLSearchParams(window.location.search);
      const code = params.get("code");
      let token = localStorage.getItem("access_token");

      // Se acabou de voltar com "code"
      if (code && !token) {
        try {
          const tokenResp = await getToken(code);

          if (tokenResp.error) {
            console.error("Erro ao obter token:", tokenResp.error);
          } else {
            localStorage.setItem("access_token", tokenResp.access_token);
            if (tokenResp.refresh_token) {
              localStorage.setItem("refresh_token", tokenResp.refresh_token);
            }
            token = tokenResp.access_token;
          }
        } catch (err) {
          console.error("Falha ao trocar code por token:", err);
        } finally {
          // Remove ?code= da URL
          window.history.replaceState({}, document.title, REDIRECT_URI);
        }
      }

      // Se n√£o h√° token ainda, mostra tela de login simples
      if (!token) {
        setLoggedOutUI();
        return;
      }

      // Testa se o token ainda √© v√°lido
      try {
        const test = await fetch("https://api.spotify.com/v1/me", {
          headers: { Authorization: `Bearer ${token}` },
        });

        if (test.status === 401) {
          // Tenta renovar
          token = await refreshAccessToken();
        }
      } catch (err) {
        console.error("Erro ao validar token:", err);
      }

      if (!token) {
        // sem token mesmo ap√≥s refresh
        localStorage.removeItem("access_token");
        localStorage.removeItem("refresh_token");
        setLoggedOutUI();
        return;
      }

      // J√° logado
      setLoggedInUI();

      async function renderRandom() {
        if (isLoadingAlbum) return;

        setLoadingAlbum(true);

        try {
          let currentToken = localStorage.getItem("access_token");
          let album;

          try {
            album = await getRandomAlbum(currentToken);
          } catch (err) {
            if (err.message === "TOKEN_EXPIRED") {
              // tenta renovar
              const newToken = await refreshAccessToken();
              if (!newToken) {
                throw err;
              }
              currentToken = newToken;
              album = await getRandomAlbum(currentToken);
            } else if (err.message === "NO_ALBUMS") {
              albumCard.classList.add("hidden");
              alert("Nenhum √°lbum salvo encontrado na sua biblioteca Spotify.");
              return;
            } else {
              throw err;
            }
          }

          mostrarAlbum(album);
        } catch (err) {
          console.error("Erro ao buscar √°lbum aleat√≥rio:", err);
          alert("N√£o foi poss√≠vel carregar um √°lbum agora. Tente novamente em instantes.");
        } finally {
          setLoadingAlbum(false);
        }
      }

      randomBtn.onclick = renderRandom;

      // primeiro √°lbum ao entrar
      renderRandom();
    }

    start();
  </script>
</body>
</html>